<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:if="ant:if" xmlns:unless="ant:unless" name="mysql-build-win">

  <property name="mysql.binary" value="mysql-5.7.12-winx64" />
  <property name="mysql.binary.file" value="${mysql.binary}.zip" />
  <property name="repository" value="C:/ProgramData/sitoolkit/repository/mysql" />


  <target name="unarchive" unless="${mysql.unarchived}">
    <unzip src="${download.home}/${mysql.binary.file}" dest="${mysql.basedir}" />
    <move file="${mysql.basedir}/${mysql.binary}" tofile="${mysql.basedir}" />
  </target>


  <target name="create-datadir" unless="${mysql.datadir.created}">
    <mkdir dir="${mysql.datadir}" />

    <exec executable="${mysql.basedir}/bin/mysqld" failonerror="true">
      <arg value="--initialize-insecure" />
      <arg value="--basedir=${mysql.basedir}" />
      <arg value="--datadir=${mysql.datadir}" />
    </exec>

  </target>


  <target name="install-openssl">
    <!-- TODO impl -->
  </target>


  <target name="create-db" unless="${mysql.db-created}">
    <copy file="${tool.home}/initialize.sql" todir="${tool.home}/target">
      <filterset>
        <filter token="db.name" value="${db.name}" />
        <filter token="db.username" value="${db.username}" />
        <filter token="db.password" value="${db.password}" />
      </filterset>
    </copy>

    <exec executable="${mysql.basedir}/bin/mysql" failonerror="true">
      <arg value="-h" />
      <arg value="${db.host}" />
      <arg value="-P" />
      <arg value="${db.port.local}" />
      <arg value="-u" />
      <arg value="root" />
      <arg value="mysql" />
      <arg value="-t" />
      <arg value="-e" />
      <arg value="source ${tool.home}/target/initialize.sql" />
    </exec>
  </target>


  <target name="start">
    <condition property="mysql.started">
      <socket server="${db.host}" port="${db.port.local}" />
    </condition>

    <echo message="Starting MySQL server ..." unless:true="${mysql.started}" />

    <echo message="basedir:${mysql.basedir}" />
    <echo message="datadir:${mysql.datadir}" />

    <copy file="${tool.home}/my.cnf"
          todir="${mysql.datadir}"
          overwrite="true"
          unless:true="${mysql.started}">
      <filterset>
        <filter token="db.port.local" value="${db.port.local}" />
        <filter token="mysql.socket" value="${mysql.socket}" />
      </filterset>
    </copy>

    <exec executable="cmd" dir="${mysql.basedir}" failonerror="true" unless:true="${mysql.started}">
      <arg value="/C"/>
      <arg value="start"/>
      <arg value="/B"/>
      <arg value="${mysql.basedir}/bin/mysqld"/>
      <arg value="--defaults-extra-file=${mysql.datadir}/my.cnf" />
      <arg value="--basedir=${mysql.basedir}" />
      <arg value="--datadir=${mysql.datadir}" />
    </exec>

    <waitfor maxwait="10" maxwaitunit="second" checkevery="500" checkeveryunit="millisecond">
      <socket server="${db.host}" port="${db.port.local}" />
    </waitfor>

    <echo message="MySQL server is started" />
  </target>


  <target name="stop">
    <echo message="Stopping MySQL server ..." />


    <exec executable="${mysql.basedir}/bin/mysqladmin" dir="${mysql.basedir}">
      <arg value="--port=${db.port.local}" />
      <arg value="-u" />
      <arg value="root" />
      <arg value="shutdown" />
    </exec>

    <property environment="env"/>

    <waitfor maxwait="10" maxwaitunit="second" checkevery="500" checkeveryunit="millisecond">
      <not>
        <available file="${mysql.datadir}/${env.COMPUTERNAME}.pid"/>
      </not>
    </waitfor>

  </target>


</project>